<!doctype html><html lang="en"><head><meta charset="utf-8"><script src="04eef697c9f00e4ec3c7.js"></script><script src="d8aec11467019c7f95d5.js"></script><script src="0c9b330400cba6d82e78.js"></script><script src="f9ab8d7da3a4af254b22.js"></script><script src="fc2b057ebd1a3c3e20d6.js"></script><script src="ad54be411b2290acb657.js"></script><link rel="stylesheet" href="13bb7e9048f30a02c70d.css"/><link rel="stylesheet" href="e641a99aa5d1d6f27c0d.css"/><link rel="stylesheet" href="86367996bc0a30d7968b.css"/><link rel="stylesheet" href="aa3bbd0b9cee1b176636.css"/><script defer="defer" src="bundle.js"></script></head><body><style>#app,body,html{height:100%;width:100%;overflow:hidden;position:relative}#map{width:99%;height:99%}.rightTopButtons{display:flex;justify-content:space-between}.ctrlPanel{position:absolute;border-radius:4px;left:10px;top:10px;padding:8px;background-color:rgba(255,255,255,.25);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.18);box-shadow:rgba(142,142,142,.19) 0 6px 15px 0;-webkit-box-shadow:rgba(142,142,142,.19) 0 6px 15px 0;-webkit-border-radius:4px;color:rgba(255,255,255,.75);width:280px}.panelItem{margin-bottom:5px;width:100%}.mybuttons{display:flex;justify-content:space-between}.drawResult{position:absolute;border-radius:4px;right:70px;top:10px;padding:8px;background-color:#fff;color:rgba(255,255,255,.75);width:300px}.el-slider{padding-right:5px;width:calc(58% - 36px)}.slider-box{position:absolute;z-index:1;display:flex;align-items:center;padding:8px 34px;background-color:rgba(255,255,255,.25);border-radius:34px;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.18);box-shadow:rgba(142,142,142,.19) 0 6px 15px 0;-webkit-box-shadow:rgba(142,142,142,.19) 0 6px 15px 0;width:455px;height:48px;left:50%;bottom:15px;transform:translateX(-50%)}.slider-text{color:#fff;display:inline-block;width:90px;text-align:center}.ctrl-select{width:120px}.play-icon{font-size:22px;color:#fff;cursor:pointer;margin-right:20px;font-weight:700}</style><div id="app"><div id="map"></div><div class="ctrlPanel"><div class="panelItem"><el-input class="panelItem" size="mini" placeholder="输入经纬度 用英文逗号,隔开" v-model="lnglatStr"></el-input><el-button type="primary" class="panelItem" size="mini" @click="locate">定位</el-button></div><el-divider></el-divider><div class="panelItem"><el-input class="panelItem" size="mini" placeholder="输入合法的 styleUrl" v-model="styleValue"></el-input><el-button type="primary" class="panelItem" size="mini" @click="replaceStyle">替换 Style</el-button></div><el-divider></el-divider><div class="panelItem"><el-input type="textarea" :rows="6" class="panelItem" size="mini" placeholder="输入合法的 features 数据 (参考右侧生成数据格式)" v-model="drawGeojsonValue"></el-input><div class="panelItem"><el-button type="primary" style="width:calc(50% - 8px)" size="mini" @click="drawGeojson">绘制</el-button><el-button type="primary" style="width:calc(50% - 8px)" size="mini" @click="clearGeojson(true)">清除</el-button></div></div><el-divider></el-divider><div class="panelItem"><el-input type="textarea" :rows="2" class="panelItem" size="mini" placeholder="输入合法的 raster tile url" v-model="rasterLayerUrl"></el-input><div class="panelItem"><el-button type="primary" style="width:calc(50% - 8px)" size="mini" @click="addRasterLayer">添加栅格Raster</el-button><el-button type="primary" style="width:calc(50% - 8px)" size="mini" @click="removeRasterLayer">移除</el-button></div></div><el-divider></el-divider><div class="panelItem"><el-input type="textarea" :rows="2" class="panelItem" size="mini" placeholder="输入合法的 vector tile url" v-model="vectorTileUrl"></el-input><el-input class="panelItem" placeholder="输入 vector 的对应 source-layer" v-model="vectorSourceLayer"></el-input><div class="panelItem"><el-button type="primary" style="width:calc(50% - 8px)" size="mini" @click="addVectorLayer">添加矢量Vector</el-button><el-button type="primary" style="width:calc(50% - 8px)" size="mini" @click="removeVectorLayer">移除</el-button></div></div><el-divider></el-divider><div class="panelItem"><el-button type="primary" style="width:100%" size="mini" @click="openThree">打开Three-Map</el-button></div></div><div class="drawResult"><el-input style="margin-bottom:8px" placeholder="绘制工具最近一条绘制/更新结果" type="textarea" :rows="6" v-model="drawResultText"></el-input><div class="rightTopButtons"><el-button type="primary" size="mini" @click="addTerrain">添加地形</el-button><el-button type="primary" size="mini" @click="removeTerrain">删除地形</el-button><el-button type="primary" size="mini" @click="copyResult">复制</el-button></div></div><el-dialog @open="dialogOpen" top="5vh" title="Three-Map 轨迹播放示例" :visible.sync="dialogVisible" width="70%" :destroy-on-close="true" @close="dialogClose"><div id="threeMapContainer" style="height:65vh"><div class="slider-box"><i class="play-icon" :class="playStatus?'el-icon-video-pause':'el-icon-video-play'" @click="playClick"></i><el-slider ref="sliderRef" v-model="currentTime" :disabled="duration === 0" :min="0" :max="duration" :show-tooltip="false" @mousedown="handleMouseDown" @mouseup="handleMouseUp" @change="handleTimeChange"></el-slider><span class="slider-text" id="slider-text"></span><el-select size="small" v-model="speed" class="ctrl-select"><el-option v-for="item of speeds" :key="item.value" :label="item.label" :value="item.value"></el-option></el-select></div></div><div style="text-align:center;width:100%;margin-top:20px"><el-button type="danger" size="mini" @click="dialogVisible = false">关闭</el-button></div></el-dialog></div><script>let map=null,dMap=null,models={},fullTrack=[],dillPath=[],lastFrame={},colorMap={};new Vue({el:"#app",data:function(){return{visible:!1,lnglatStr:"",drawResultText:"",styleValue:"",drawGeojsonValue:"",rasterLayerUrl:"",vectorTileUrl:"",vectorSourceLayer:"",dialogVisible:!1,modelNumber:0,playStatus:!1,speed:1,currentTime:0,duration:0,speeds:[{value:.25,label:"x 0.25"},{value:.5,label:"x 0.5"},{value:1,label:"正常速度"},{value:1.5,label:"x 1.5"},{value:2,label:"x 2"}],timeShouldChange:!0}},methods:{handleTimeChange(e){if(e){const t=Math.floor(e);this.currentTime=t,this.timeTo(e)}},getClosestIndex(e,t){let a=0,r=Math.abs(t-new Date(e[0].frameTime).getTime());for(let o=1;o<e.length;o++){const l=Math.abs(t-new Date(e[o].frameTime).getTime());l<r&&(r=l,a=o)}return a},timeTo(e){let t=new Date(fullTrack[0].frameTime).getTime()+e,a=this.getClosestIndex(fullTrack,t);dillPath=fullTrack.slice(a)},formatTime(e){let t=Math.round(e/1e3);const a=Math.floor(t/60),r=Math.floor(t%60);return`${a<10?"0"+a:a}:${r<10?"0"+r:r}`},playClick(){this.playStatus=!this.playStatus,this.playStatus?this.continuePlay():this.pause()},pause(){this.playStatus=!1},continuePlay(){this.playStatus=!0,this.renderPath()},handleMouseDown(){this.timeShouldChange=!1},handleMouseUp(){this.timeShouldChange=!0},dialogOpen(){this.$nextTick((()=>{const e=this.$refs.sliderRef.$el;e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("mousedown",this.handleMouseDown),dMap=new mapboxgl.Map({container:"threeMapContainer",style:"mapbox://styles/mapbox/dark-v11",center:[110.70727046509603,33.05124063231834],zoom:11,pitch:45}),dMap.on("style.load",(()=>{dMap.addLayer({id:"vehicle3D",type:"custom",renderingMode:"3d",onAdd:(e,t)=>{window.tb=new Threebox(e,t,{defaultLights:!0,enableSelectingObjects:!1});for(let e of[1,2,3,4,5]){let t={obj:`model/car${e}.gltf`,type:"gltf",units:"meters",scale:.8,adjustment:{x:.5,y:1,z:-.5},bbox:!0};window.tb.loadObj(t,(t=>{models[`car${e}`]=t,this.modelNumber+=1}))}},render:function(e,t){window.tb.update()}})}));let t=setInterval((()=>{5===this.modelNumber&&(clearInterval(t),fetch("libs/tracks.json").then((e=>{e.json().then((e=>{fullTrack=e.blog_tracks;let t=new Date(fullTrack[fullTrack.length-1].frameTime).getTime()-new Date(fullTrack[0].frameTime).getTime();this.duration=t,dillPath=JSON.parse(JSON.stringify(fullTrack)),this.playStatus=!0,dMap.flyTo({center:[dillPath[0].carInfo[0].longitude,dillPath[0].carInfo[0].latitude],zoom:19}),this.renderPath(!0)}))})))}),500)}))},renderPath(e){if(this.playStatus&&dillPath.length){let t=dillPath[0].carInfo,a=this.diff(lastFrame.carInfo||[],t||[]),r=new Date(dillPath[0].frameTime).getTime()-new Date(fullTrack[0].frameTime).getTime();this.timeShouldChange&&(this.currentTime=r),document.getElementById("slider-text").innerText=`${this.formatTime(this.currentTime)}/${this.formatTime(this.duration)}`;let o=0;e||(o=new Date(dillPath[0].frameTime).getTime()-new Date(lastFrame.frameTime).getTime()>1e3?100:new Date(dillPath[0].frameTime).getTime()-new Date(lastFrame.frameTime).getTime()),o/=this.speed,lastFrame=Object.assign({},dillPath[0],{carInfo:t}),this.addDelUpdateVehicleModels(a,o),dillPath.shift(),dillPath.length||(dillPath=JSON.parse(JSON.stringify(fullTrack))),setTimeout((()=>{this.renderPath(!1)}),o)}},addDelUpdateVehicleModels(e,t){if(window.tb&&window.tb.world.children)for(let a of e){if("add"===a.dill){console.log(a.originalType);let e=models[`car${a.originalType}`].duplicate();e.setCoords([a.longitude,a.latitude]),e.userData.data=a,e.setRotation({x:90,y:360-a.courseAngle-90,z:0}),window.tb.add(e,a.id)}if("del"===a.dill&&window.tb.clear(a.id,!0),"com"===a.dill)for(let e of window.tb.world.children)e.userData.data?.id===a.id&&this.setModel(e,a,t)}},setModel(e,t,a){if(0===a)e.setCoords([t.longitude,t.latitude]);else{let r=a/4,o=turf.midpoint([e.userData.data.longitude,e.userData.data.latitude],[t.longitude,t.latitude]),l=turf.midpoint([e.userData.data.longitude,e.userData.data.latitude],o.geometry.coordinates),i=turf.midpoint(o.geometry.coordinates,[t.longitude,t.latitude]);setTimeout((()=>{e.setCoords(l.geometry.coordinates)}),r),setTimeout((()=>{e.setCoords(o.geometry.coordinates)}),2*r),setTimeout((()=>{e.setCoords(i.geometry.coordinates)}),3*r),setTimeout((()=>{e.setCoords([t.longitude,t.latitude])}),4*r)}e.userData.data=t,e.setRotation({x:90,y:360-t.courseAngle-90,z:0})},diff(e,t){const a=t.filter((t=>!e.find((e=>e.id===t.id)))),r=e.filter((e=>!t.find((t=>t.id===e.id)))),o=t.filter((t=>e.find((e=>e.id===t.id))));return a.forEach((e=>e.dill="add")),r.forEach((e=>e.dill="del")),o.forEach((e=>e.dill="com")),[...a,...r,...o]},dialogClose(){window.tb?.dispose(),dMap?.remove(),window.tb=null,dMap=null},openThree(){this.dialogVisible=!0},addTerrain(){map.setTerrain({source:"mapbox-dem",exaggeration:1.5})},removeTerrain(){map.setTerrain(null)},addVectorLayer(){map.getSource("vectorSource")||map.addSource("vectorSource",{type:"vector",tiles:[this.vectorTileUrl]}),map.getLayer("vectorLayer")||map.addLayer({id:"vectorLayer",type:"circle",source:"vectorSource","source-layer":this.vectorSourceLayer,paint:{"circle-color":"red","circle-radius":2}})},removeVectorLayer(){map.getLayer("vectorLayer")&&map.removeLayer("vectorLayer"),map.getSource("vectorSource")&&map.removeSource("vectorSource")},addRasterLayer(){if(map.getLayer("customRaster-layer"))this.$notify.warning({title:"请先移除已存在栅格图层！"});else{let e={id:"customRaster-layer",type:"raster",source:{type:"raster",tiles:[this.rasterLayerUrl],tileSize:256}};map.addLayer(e)}},removeRasterLayer(){map.getLayer("customRaster-layer")&&(map.removeLayer("customRaster-layer"),map.removeSource("customRaster-layer")),this.rasterLayerUrl=""},clearGeojson(e){map.getLayer("customSource-layer")&&(map.removeLayer("customSource-layer"),map.removeSource("customSource")),e&&(this.drawGeojsonValue="")},drawGeojson(){if(this.clearGeojson(),this.drawGeojsonValue){let e=turf.featureCollection(JSON.parse(this.drawGeojsonValue));map.getSource("customSource")?map.getSource("customSource").setData(e):(map.addSource("customSource",{type:"geojson",data:e}),"LineString"===e.features[0].geometry.type&&map.addLayer({id:"customSource-layer",type:"line",source:"customSource",paint:{"line-color":"red","line-width":2}}),"Polygon"===e.features[0].geometry.type&&map.addLayer({id:"customSource-layer",type:"fill",source:"customSource",paint:{"fill-color":"rgba(243, 15, 53,0.5)"}}),"Point"===e.features[0].geometry.type&&map.addLayer({id:"customSource-layer",type:"circle",source:"customSource",paint:{"circle-color":"red","circle-radius":10}}))}},replaceStyle(){try{map.setStyle(this.styleValue)}catch(e){this.$notify.error({title:"输入非法！",message:e})}},locate(e){console.log(e);try{let e=this.lnglatStr.split(",");map.flyTo({center:e,zoom:18})}catch(e){this.$notify.error({title:"输入非法！",message:e})}},copyResult(){const e=document.createElement("input");e.setAttribute("readonly","readonly"),e.setAttribute("value",this.drawResultText),document.body.appendChild(e),e.setSelectionRange(0,9999),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.$notify.success({title:"复制成功！"})}},mounted(){mapboxgl.accessToken="pk.eyJ1IjoibmluZ2x4IiwiYSI6ImNsYnlnM2s2ODBnNmIzcHBpbzY5aDh3bHAifQ.hQL4zLjBss5i4x-zuFp9tg",map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/satellite-streets-v12",center:[110.70727046509603,33.05124063231834],zoom:2});var e=new MapboxDraw({displayControlsDefault:!1,controls:{polygon:!0,line_string:!0,point:!0,trash:!0}});map.addControl(e),map.on("load",(()=>{map.on("click",(e=>{console.log(e.lngLat),console.log(map.getCenter()),console.log(map.getBearing()),console.log(map.getZoom()),console.log(map.getPitch())}))})),map.on("style.load",(()=>{map.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14})})),map.on("draw.create",(e=>{let t=JSON.stringify(e.features);this.drawResultText=t})),map.on("draw.update",(e=>{let t=JSON.stringify(e.features);this.drawResultText=t}))}})</script></body></html>